// Generated by CoffeeScript 1.6.3
(function() {
  var $;

  $ = jQuery;

  $.fn.khausNumberFormat = function() {
    return this.each(function() {
      var number, replaceNumber;
      replaceNumber = function(number) {
        number = number.replace(/[^0-9]+/g, "");
        return number = number.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      };
      if ($(this).is(":input")) {
        number = $(this).val();
        return $(this).val(replaceNumber(number));
      } else {
        number = $(this).html();
        return $(this).html(replaceNumber(number));
      }
    });
  };

  $.fn.khausInputMoney = function() {
    return this.each(function() {
      $(this).khausInputNumber();
      $(this).khausNumberFormat();
      return $(this).on("keydown", function(t) {
        var p,
          _this = this;
        p = t.keyCode;
        if (p !== 37 && p !== 39 && p !== 13) {
          return setTimeout(function() {
            return $(_this).khausNumberFormat();
          }, 1);
        }
      });
    });
  };

  $.fn.khausInputRut = function() {
    return this.each(function() {
      var number;
      $(this).khausInputNumber();
      $(this).attr("maxlength", 12);
      number = $(this).val();
      number = number.replace(/[^0-9kK]+/g, "");
      number = number.replace(/([0-9kK])$/, "-$1");
      number = number.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      $(this).val(number);
      return $(this).on("keydown", function(t) {
        var p,
          _this = this;
        p = t.keyCode;
        if (p !== 37 && p !== 39) {
          return setTimeout(function() {
            number = $(_this).val();
            number = number.replace(/[^0-9kK]+/g, "");
            number = number.replace(/([0-9kK])$/, "-$1");
            number = number.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return $(_this).val(number);
          }, 1);
        }
      });
    });
  };

  $.fn.khausInputNumber = function() {
    return this.each(function() {
      return $(this).on("keydown", function(t) {
        var p, rex;
        p = t.keyCode;
        if (p !== 8 && p !== 37 && p !== 39 && p !== 9) {
          rex = new RegExp("[0-9]");
          if (!String.fromCharCode(t.keyCode).match(rex) && !(p >= 96 && p <= 105)) {
            return t.preventDefault();
          }
        }
      });
    });
  };

  $.fn.khausForm = function(settings) {
    var o;
    o = $.extend({
      refresh: true,
      popoverContainer: false,
      async: true,
      send: function() {},
      response: function(message, formData) {}
    }, settings);
    return this.each(function() {
      var form, hash, message;
      form = $(this);
      if (form.is("form")) {
        hash = form.attr("action") + form.attr("method") + form.attr("class") + form.attr("id");
        hash = btoa(hash);
        message = localStorage.getItem("khausFormResponse_" + hash);
        if (message != null) {
          o.response(JSON.parse(message));
          localStorage.removeItem("khausFormResponse_" + hash);
        }
        return form.on("submit", function(e) {
          var formData;
          e.preventDefault();
          o.send();
          form.find(".popover").remove();
          formData = form.serialize();
          return $.ajax(form.attr("action"), {
            dataType: "json",
            type: form.attr("method"),
            async: o.async,
            data: formData
          }).done(function(response) {
            var paramFormData, resp;
            if ($.isPlainObject(response) && typeof response.khausFormResponse !== "undefined") {
              resp = response.khausFormResponse;
              if (resp['form-errors'] != null) {
                return $.each(resp['form-errors'], function(key, value) {
                  return form.find(":input[name=" + key + "]").popover("destroy").popover({
                    trigger: "manual",
                    content: value,
                    container: o.popoverContainer
                  }).popover("show");
                });
              } else if (resp['form-location'] != null) {
                return window.location = resp['form-location'];
              } else {
                if (o.refresh) {
                  localStorage.setItem("khausFormResponse_" + hash, JSON.stringify(resp));
                  return location.reload();
                } else {
                  paramFormData = {};
                  $.each(form.serializeArray(), function(k, v) {
                    return paramFormData[v.name] = v.value;
                  });
                  return o.response(resp, paramFormData);
                }
              }
            } else {
              if (o.refresh) {
                localStorage.setItem("khausFormResponse_" + hash, JSON.stringify(response));
                return location.reload();
              } else {
                paramFormData = {};
                $.each(form.serializeArray(), function(k, v) {
                  return paramFormData[v.name] = v.value;
                });
                o.response(response, paramFormData);
              }
            }
          });
        });
      }
    });
  };

  $.khausNotify = function(content, settings) {
    var container, contentData, o;
    if (content != null) {
      contentData = {};
      o = $.extend({
        delay: 5000
      }, settings);
      container = $(".khaus-notify-container");
      if (container.size() === 0) {
        container = $("<div>", {
          "class": "khaus-notify-container"
        }).prependTo("body");
      }
      if ($.isPlainObject(content)) {
        if (content.khausFormResponse) {
          contentData = content.khausFormResponse;
        } else {
          contentData = content;
        }
      } else {
        contentData = {
          success: content
        };
      }
      return $.each(contentData, function(type, message) {
        var notify;
        notify = $("<div>", {
          "class": "khaus-notify khaus-notify-" + type
        });
        notify.html(message);
        notify.appendTo(container);
        notify.on("click", function() {
          $(this).removeClass("khaus-notify-show");
          $(this).addClass("khaus-notify-hide");
          return $(this).one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend", function() {
            return $(this).remove();
          });
        });
        return setTimeout(function() {
          notify.addClass("khaus-notify-show");
          if (o.delay > 0) {
            return setTimeout(function() {
              return notify.trigger("click");
            }, o.delay);
          }
        }, 1);
      });
    }
  };

  $.khausAlert = function(title, message) {
    var modal_D1, modal_D2, modal_D3, modal_body, modal_footer, modal_header;
    if ($(".khaus-modal-alert").size() > 0) {
      $(".khaus-modal-alert").remove();
    }
    modal_D1 = $("<div>", {
      "class": "modal fade khaus-modal-alert"
    });
    modal_D2 = $("<div>", {
      "class": "modal-dialog"
    }).appendTo(modal_D1);
    modal_D3 = $("<div>", {
      "class": "modal-content"
    }).appendTo(modal_D2);
    modal_header = $("<div>", {
      "class": "modal-header"
    }).appendTo(modal_D3);
    $("<h4>", {
      "class": "modal-title"
    }).html(title).appendTo(modal_header);
    modal_body = $("<div>", {
      "class": "modal-body"
    }).html(message).appendTo(modal_D3);
    modal_footer = $("<div>", {
      "class": "modal-footer"
    }).appendTo(modal_D3);
    $("<button>", {
      "type": "button",
      "class": "btn btn-primary",
      "data-dismiss": "modal"
    }).html("Aceptar").appendTo(modal_footer);
    return modal_D1.modal("show");
  };

  $.khausConfirm = function(title, message, callback) {
    var modal_D1, modal_D2, modal_D3, modal_body, modal_footer, modal_header;
    if (callback == null) {
      callback = function() {};
    }
    if ($(".khaus-modal-confirm").size() > 0) {
      $(".khaus-modal-confirm").remove();
    }
    modal_D1 = $("<div>", {
      "class": "modal fade khaus-modal-confirm"
    });
    modal_D2 = $("<div>", {
      "class": "modal-dialog"
    }).appendTo(modal_D1);
    modal_D3 = $("<div>", {
      "class": "modal-content"
    }).appendTo(modal_D2);
    modal_header = $("<div>", {
      "class": "modal-header"
    }).appendTo(modal_D3);
    $("<h4>", {
      "class": "modal-title"
    }).html(title).appendTo(modal_header);
    modal_body = $("<div>", {
      "class": "modal-body"
    }).html(message).appendTo(modal_D3);
    modal_footer = $("<div>", {
      "class": "modal-footer"
    }).appendTo(modal_D3);
    $("<button>", {
      "type": "button",
      "class": "btn btn-default",
      "data-dismiss": "modal"
    }).html("Cancelar").appendTo(modal_footer);
    $("<button>", {
      "type": "button",
      "class": "btn btn-primary",
      "data-dismiss": "modal"
    }).html("Aceptar").on("click", function() {
      callback();
    }).appendTo(modal_footer);
    return modal_D1.modal("show");
  };

  $.bootstrapAlert = function(message, style) {
    var div;
    if (style == null) {
      style = "";
    }
    div = $("<div>", {
      "class": "alert alert-dismissable " + style
    }).html(message);
    $("<button>", {
      "class": "close",
      "data-dismiss": "alert",
      "aria-hidden": "true"
    }).html("&times;").prependTo(div);
    return div;
  };

}).call(this);
